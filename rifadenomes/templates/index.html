{% extends "layout.html" %}

{% block body %}
    <h1>Escolha Nomes</h1>
    <form id="formulario" action="/salvar" method="POST">
        <div id="nomes"></div>
        <input autocomplte=off autofocus type="text" name="nome" placeholder="Seu nome" required>
        <input type="hidden" id="escolhas" name="escolhas" value="">
        <button type="submit">Registrar</button>
    </form>

    <script>
        const nomesDiv = document.getElementById("nomes");
        const escolhasInput = document.getElementById("escolhas");
        const nomesEscolhidos = new Set();

        // Function to refresh the selection dictionary table
        function refreshDicionario() {
            fetch('/dicionario')
                .then(response => response.json())
                .then(data => {
                    const dicionarioTable = document.querySelector("#dicionario tbody");
                    dicionarioTable.innerHTML = ""; // Clear existing rows

                    for (const [nome, selecionadoPor] of Object.entries(data)) {
                        const row = document.createElement("tr");

                        const nomeCell = document.createElement("td");
                        nomeCell.textContent = nome;
                        row.appendChild(nomeCell);

                        const selecionadoPorCell = document.createElement("td");
                        selecionadoPorCell.textContent = selecionadoPor;
                        row.appendChild(selecionadoPorCell);

                        dicionarioTable.appendChild(row);
                    }
                })
                .catch(error => console.error("Erro ao carregar o dicionário:", error));
        }

        // Fetch the list of names and already chosen names
        fetch('/nomes')
            .then(response => response.json())
            .then(data => {
                const allNames = data.all_names;
                const takenNames = new Set(data.taken_names);

                // Generate name boxes
                allNames.forEach(fullName => {
                    const nameBox = document.createElement("div");
                    nameBox.classList.add("nome");
                    nameBox.textContent = fullName;

                    // Disable already chosen names
                    if (takenNames.has(fullName)) {
                        nameBox.classList.add("desabilitado");
                    } else {
                        nameBox.addEventListener("click", () => {
                            if (nomesEscolhidos.has(fullName)) {
                                nomesEscolhidos.delete(fullName);
                                nameBox.classList.remove("selecionado");
                            } else {
                                nomesEscolhidos.add(fullName);
                                nameBox.classList.add("selecionado");
                            }
                            escolhasInput.value = Array.from(nomesEscolhidos).join(",");
                        });
                    }
                    nomesDiv.appendChild(nameBox);
                });
            })
            .catch(error => console.error('Erro ao buscar nomes:', error));

        // Refresh dictionary on page load
        refreshDicionario();

        // Submit form and refresh dictionary
        const form = document.getElementById("formulario");
        form.addEventListener("submit", event => {
            event.preventDefault(); // Prevent page reload
            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        form.reset();
                        escolhasInput.value = "";
                        nomesEscolhidos.clear();
                        refreshDicionario();
                        alert("Dados salvos com sucesso!");
                    } else {
                        response.text().then(text => alert(text));
                    }
                })
                .catch(error => console.error("Erro ao enviar formulário:", error));
        });
    </script>
{% endblock %}


<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escolha Nomes</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>

</body>

</html>
